(()=>{var e={n:r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return e.d(t,{a:t}),t},d:(r,t)=>{for(var s in t)e.o(t,s)&&!e.o(r,s)&&Object.defineProperty(r,s,{enumerable:!0,get:t[s]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},r={};(()=>{"use strict";e.r(r),e.d(r,{extend:()=>xe});const t=flarum.reg.get("core","forum/app");var s=e.n(t);const a=flarum.reg.get("core","common/states/PaginatedListState");var o=e.n(a);class n extends(o()){constructor(){super({},1,null)}get type(){return"user-erasure-requests"}load(){return s().session.user?.attribute("erasureRequestCount")&&(this.pages=[],this.location={page:1}),this.pages.length>0?Promise.resolve():super.loadNext()}}flarum.reg.add("flarum-gdpr","forum/states/ErasureRequestsListState",n);const u=flarum.reg.get("core","common/extend"),i=flarum.reg.get("core","common/utils/ItemList");var l=e.n(i);const d=flarum.reg.get("core","common/components/FieldSet");var c=e.n(d);const p=flarum.reg.get("core","common/components/Button");var f=e.n(p);function g(e){return g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g(e)}function h(e,r,t){return(r=function(e){var r=function(e){if("object"!=g(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=g(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==g(r)?r:r+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}const b=flarum.reg.get("core","common/components/Form");var v=e.n(b);const y=flarum.reg.get("core","common/components/FormModal");var x=e.n(y);const q=flarum.reg.get("core","common/utils/extractText");var N=e.n(q);const _=flarum.reg.get("core","common/utils/Stream");var w=e.n(_);class A extends(x()){constructor(){super(...arguments),h(this,"reason",void 0),h(this,"password",void 0),h(this,"user",void 0)}oninit(e){super.oninit(e),this.reason=w()(""),this.password=w()(""),this.user=s().session.user}className(){return"RequestErasureModal Modal--small"}title(){return s().translator.trans("flarum-gdpr.forum.request_erasure.title")}content(){return m("div",{className:"Modal-body"},m(v(),{className:"Form--centered"},this.fields().toArray()))}fields(){const e=new(l()),r=this.user?.erasureRequest();return r&&"cancelled"!==r.status()?(e.add("status",m("div",{className:"Form-group"},m("p",{className:"helpText"},s().translator.trans(`flarum-gdpr.forum.request_erasure.status.${r.status()}`)))),r.reason()&&e.add("reason",m("div",{className:"Form-group"},m("p",{className:"helpText"},s().translator.trans("flarum-gdpr.forum.request_erasure.reason",{reason:r.reason()})))),e.add("cancel",m("div",{className:"Form-group"},f().component({className:"Button Button--primary Button--block",onclick:this.oncancel.bind(this),loading:this.loading},s().translator.trans("flarum-gdpr.forum.request_erasure.cancel_button"))))):(e.add("text",m("p",{className:"helpText"},s().translator.trans("flarum-gdpr.forum.request_erasure.text"))),s().forum.attribute("passwordlessSignUp")||e.add("password",m("div",{className:"Form-group"},m("input",{type:"password",className:"FormControl",bidi:this.password,placeholder:N()(s().translator.trans("flarum-gdpr.forum.request_erasure.password_label"))}))),e.add("reason",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.reason(),oninput:e=>{const r=e.target;r&&this.reason(r.value)},placeholder:N()(s().translator.trans("flarum-gdpr.forum.request_erasure.reason_label")),rows:6}))),e.add("submit",m("div",{className:"Form-group"},f().component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading},s().translator.trans("flarum-gdpr.forum.request_erasure.request_button"))))),e}oncancel(e){if(this.loading=!0,m.redraw(),this.user){const e=this.user.erasureRequest();s().request({method:"POST",url:s().forum.attribute("apiUrl")+"/user-erasure-requests/"+e.id()+"/cancel"}).then((()=>{this.loading=!1,s().modal.close()}))}}data(){return{reason:this.reason()}}onsubmit(e){e.preventDefault(),this.loading=!0,s().store.createRecord("user-erasure-requests").save(this.data(),{meta:{password:this.password()}}).then((e=>{this.user&&this.user.pushData({relationships:{erasureRequest:e}}),this.loading=!1,m.redraw()})).catch((()=>{this.loading=!1,m.redraw()}))}}flarum.reg.add("flarum-gdpr","forum/components/RequestErasureModal",A);const B=flarum.reg.get("core","common/app");var E=e.n(B);const M=flarum.reg.get("core","common/components/Modal");var R=e.n(M);const S=flarum.reg.get("core","common/helpers/username");var C=e.n(S);const D=flarum.reg.get("core","common/components/Avatar");var F=e.n(D);class z extends(R()){constructor(){super(...arguments),h(this,"user",void 0)}oninit(e){super.oninit(e),this.user=this.attrs.user}className(){return"RequestDataModal Modal--small"}title(){return E().translator.trans("flarum-gdpr.lib.request_data.title",{username:C()(this.user)})}content(){return m("div",{className:"Modal-body"},m(v(),{className:"Form--centered"},m("div",{className:"User"},m(F(),{user:this.user})),m("p",{className:"helpText"},E().translator.trans("flarum-gdpr.lib.request_data.text")),m("div",{className:"Form-group"},m(f(),{className:"Button Button--primary Button--block",onclick:()=>this.requestExport(),loading:this.loading,disabled:this.loading},E().translator.trans("flarum-gdpr.lib.request_data.request_button")))))}requestExport(){this.loading=!0,E().request({method:"POST",url:E().forum.attribute("apiUrl")+"/gdpr-exports",body:{data:{attributes:{userId:this.user.id()}}}}).then(this.hide.bind(this),this.loaded.bind(this))}}function k(){(0,u.extend)("flarum/forum/components/SettingsPage","settingsItems",(function(e){this.user&&e.add("dataItems",m(c(),{className:"Settings-gdpr FieldSet--form",label:s().translator.trans("flarum-gdpr.forum.settings.data.heading")},this.dataItems().toArray()),-100)})),(0,u.override)("flarum/forum/components/SettingsPage","dataItems",(function(){const e=new(l());return e.add("gdprErasure",m("div",{className:"Form-group gdprErasure-container"},m("p",{className:"helpText"},s().translator.trans("flarum-gdpr.forum.settings.request_erasure_help")),m(f(),{className:"Button Button-gdprErasure",icon:"fas fa-user-minus",onclick:()=>s().modal.show(A)},s().translator.trans("flarum-gdpr.forum.settings.request_erasure_button"))),50),e.add("gdprExport",m("div",{className:"Form-group gdprExport-container"},m("p",{className:"helpText"},s().translator.trans("flarum-gdpr.forum.settings.export_data_help")),m(f(),{className:"Button Button-gdprExport",icon:"fas fa-file-export",onclick:()=>s().modal.show(z,{user:this.user})},s().translator.trans("flarum-gdpr.forum.settings.export_data_button"))),40),e}))}flarum.reg.add("flarum-gdpr","common/components/RequestDataExportModal",z),flarum.reg.add("flarum-gdpr","forum/extenders/extendUserSettingsPage",k);const P=flarum.reg.get("core","forum/components/HeaderSecondary");var T=e.n(P);const U=flarum.reg.get("core","forum/components/NotificationsDropdown");var I=e.n(U);const O=flarum.reg.get("core","common/Component");var L=e.n(O);const j=flarum.reg.get("core","forum/components/HeaderList");var H=e.n(j);const $=flarum.reg.get("core","forum/components/HeaderListItem");var G=e.n($);const J=flarum.reg.get("core","forum/components/UserCard");var K=e.n(J);class Q extends(x()){constructor(){super(...arguments),h(this,"comments",void 0),h(this,"loadingAnonymization",!1),h(this,"loadingDeletion",!1),h(this,"request",void 0)}oninit(e){super.oninit(e),this.request=this.attrs.request,this.comments=w()("")}className(){return"ProcessErasureRequestModal Modal--medium"}title(){return s().translator.trans("flarum-gdpr.forum.process_erasure.title")}content(){return m("div",{className:"Modal-body"},m(v(),{className:"Form--centered"},this.fields().toArray()))}fields(){const e=new(l()),r=this.attrs.request;return e.add("text",m("div",null,m(K(),{className:"UserCard--popover UserCard--gdpr",controlsButtonClassName:"Button",user:this.request.user()}),m("p",{className:"helpText"},s().translator.trans("flarum-gdpr.forum.process_erasure.text",{name:C()(this.request.user())})))),r?.reason()&&e.add("reason",m("p",{className:"helpText"},m("code",null,r.reason()))),e.add("comments",m("div",{className:"Form-group"},m("textarea",{className:"FormControl",value:this.comments(),bidi:this.comments,placeholder:N()(s().translator.trans("flarum-gdpr.forum.process_erasure.comments_label"))}))),s().forum.attribute("erasureAnonymizationAllowed")&&e.add("anonymize",m("div",{className:"Form-group"},f().component({className:"Button Button--primary Button--block",loading:this.loadingAnonymization,onclick:()=>this.process("anonymization")},s().translator.trans("flarum-gdpr.forum.process_erasure.anonymization_button")))),s().forum.attribute("erasureDeletionAllowed")&&e.add("delete",m("div",{className:"Form-group"},f().component({className:"Button Button--danger Button--block",loading:this.loadingDeletion,onclick:()=>this.process("deletion")},s().translator.trans("flarum-gdpr.forum.process_erasure.deletion_button")))),e}process(e){confirm(s().translator.trans("flarum-gdpr.forum.process_erasure.confirm",{name:N()(C()(this.request.user())),mode:e},!0))&&("anonymization"===e?this.loadingAnonymization=!0:this.loadingDeletion=!0,m.redraw(),this.request.save({processedMode:e,processorComment:this.comments()}).then((e=>{s().store.remove(e),this.loadingAnonymization=!1,this.loadingDeletion=!1,m.redraw(),this.hide()})).catch((()=>{this.loadingAnonymization=!1,this.loadingDeletion=!1,m.redraw()})))}}flarum.reg.add("flarum-gdpr","forum/components/ProcessErasureRequestModal",Q);class V extends(L()){view(){const e=this.attrs.state;return m(H(),{className:"ErasureRequestsList",title:s().translator.trans("flarum-gdpr.forum.erasure_requests.title"),controls:this.controlItems(),hasItems:e.hasItems(),loading:e.isLoading(),emptyText:s().translator.trans("flarum-gdpr.forum.erasure_requests.empty_text"),loadMore:()=>e.hasNext()&&!e.isLoadingNext()&&e.loadNext()},m("ul",{className:"HeaderListGroup-content"},this.content(e)))}showModal(e){s().modal.show(Q,{request:e})}controlItems(){return new(l())}content(e){return!e.isLoading()&&e.hasItems()?e.getPages().map((e=>e.items.map(((e,r)=>m("li",null,m(G(),{key:r,className:"EraseRequest",onclick:this.showModal.bind(this,e),avatar:m(F(),{user:e.user()}),icon:"fas fa-user-edit",content:s().translator.trans("flarum-gdpr.forum.erasure_requests.item_text",{name:C()(e.user())}),datetime:e.createdAt(),excerpt:""})))))):null}}flarum.reg.add("flarum-gdpr","forum/components/ErasureRequestsList",V);class W extends(I()){static initAttrs(e){e.label=e.label||s().translator.trans("flarum-gdpr.forum.erasure_requests.tooltip"),e.icon=e.icon||"fas fa-user-minus",super.initAttrs(e)}getContent(){return m(V,{state:this.attrs.state})}goToRoute(){m.route.set(s().route("erasure-requests"))}getUnreadCount(){return this.attrs.state.hasItems()?s().store.all("erasure-requests").length:s().forum.attribute("erasureRequestCount")}getNewCount(){return this.getUnreadCount()}}function X(){(0,u.extend)(T().prototype,"items",(function(e){s().forum.attribute("erasureRequestCount")&&e.add("erasureRequests",m(W,{state:s().erasureRequests}),20)}))}flarum.reg.add("flarum-gdpr","forum/components/ErasureRequestsDropdown",W),flarum.reg.add("flarum-gdpr","forum/extenders/extendHeaderSecondary",X);const Y=flarum.reg.get("core","common/components/Page");var Z=e.n(Y);function ee(){(0,u.extend)(Z().prototype,"oninit",(function(){m.route.param("erasureRequestConfirmed")&&s().alerts.show({type:"success"},s().translator.trans("flarum-gdpr.forum.erasure_request_confirmed"))}))}flarum.reg.add("flarum-gdpr","forum/extenders/extendPage",ee);const re=flarum.reg.get("core","forum/utils/UserControls");var te=e.n(re);class se extends(R()){constructor(){super(...arguments),h(this,"user",void 0),h(this,"loadingAnonymization",!1),h(this,"loadingDeletion",!1)}oninit(e){super.oninit(e),this.user=this.attrs.user}className(){return"DeleteUserModal Modal--small"}title(){return s().translator.trans("flarum-gdpr.forum.delete_user.title",{username:C()(this.user)})}content(){return m("div",{className:"Modal-body"},m(v(),{className:"Form--centered"},m("p",{className:"helpText"},s().translator.trans("flarum-gdpr.forum.delete_user.text",{username:C()(this.user)})),m("div",{className:"Form-group"},m(f(),{className:"Button Button--primary Button--block",onclick:()=>this.defaultErasure(),loading:this.loading,disabled:this.loading},s().translator.trans("flarum-gdpr.forum.delete_user.modal_delete_button"))),s().forum.attribute("erasureAnonymizationAllowed")&&s().forum.attribute("erasureDeletionAllowed")&&m("div",null,m("div",{className:"Form-group"},m(f(),{className:"Button Button--block",onclick:()=>this.specificErasure("anonymization"),loading:this.loadingAnonymization,disabled:this.loadingAnonymization},s().translator.trans("flarum-gdpr.forum.process_erasure.anonymization_button"))),m("div",{className:"Form-group"},m(f(),{className:"Button Button--danger Button--block",onclick:()=>this.specificErasure("deletion"),loading:this.loadingDeletion,disabled:this.loadingDeletion},s().translator.trans("flarum-gdpr.forum.process_erasure.deletion_button"))))))}defaultErasure(){this.loading=!0,this.user.delete().then((()=>{this.hide(),this.loading=!1,m.redraw()}),(()=>{}))}specificErasure(e){"anonymization"===e?this.loadingAnonymization=!0:this.loadingDeletion=!0,this.user.delete({gdprMode:e}).then((()=>{this.hide(),this.loadingAnonymization=!1,this.loadingDeletion=!1,m.redraw()}),(()=>[]))}}function ae(){(0,u.extend)(te(),"moderationControls",(function(e,r){r.canModerateExports()&&e.add("gdpr-export",m(f(),{icon:"fas fa-file-export",onclick:()=>s().modal.show(z,{user:r})},s().translator.trans("flarum-gdpr.forum.settings.export_data_button")))})),(0,u.extend)(te(),"destructiveControls",(function(e,r){e.remove("delete"),r.canDelete()&&e.add("gdpr-erase",m(f(),{icon:"fas fa-eraser",onclick:()=>s().modal.show(se,{user:r})},s().translator.trans("flarum-gdpr.forum.delete_user.delete_button")))}))}flarum.reg.add("flarum-gdpr","forum/components/DeleteUserModal",se),flarum.reg.add("flarum-gdpr","forum/extenders/extendUserControls",ae);const oe=flarum.reg.get("core","common/models/User");var ne=e.n(oe);const ue=flarum.reg.get("core","common/components/Badge");var me=e.n(ue);const ie=flarum.reg.get("core","common/extenders");var le=e.n(ie);class de extends(Z()){oninit(e){super.oninit(e),s().history.push("erasure-requests"),s().erasureRequests.load(),this.bodyClass="App--ErasureRequests"}view(){return m("div",{className:"ErasureRequestsPage"},m(V,{state:s().erasureRequests}))}}flarum.reg.add("flarum-gdpr","forum/components/ErasureRequestsPage",de);const ce=flarum.reg.get("core","common/Model");var pe=e.n(ce);class fe extends(pe()){status(){return pe().attribute("status").call(this)}reason(){return pe().attribute("reason").call(this)}createdAt(){return pe().attribute("createdAt",pe().transformDate).call(this)}userConfirmedAt(){return pe().attribute("userConfirmedAt",pe().transformDate).call(this)}processedAt(){return pe().attribute("processedAt",pe().transformDate).call(this)}processorComment(){return pe().attribute("processorComment").call(this)}processedMode(){return pe().attribute("processedMode").call(this)}user(){return pe().hasOne("user").call(this)}processedBy(){return pe().hasOne("processedBy").call(this)}}flarum.reg.add("flarum-gdpr","common/models/ErasureRequest",fe);class ge extends(pe()){file(){return pe().attribute("file").call(this)}createdAt(){return pe().attribute("createdAt",pe().transformDate)}destroysAt(){return pe().attribute("destroysAt",pe().transformDate)}user(){return pe().hasOne("user")}actor(){return pe().hasOne("actor")}}flarum.reg.add("flarum-gdpr","common/models/Export",ge);const he=[(new(le().Store)).add("user-erasure-requests",fe).add("gdpr-exports",ge),new(le().Model)(ne()).attribute("canModerateExports").attribute("anonymized").hasOne("erasureRequest")],be=flarum.reg.get("core","forum/components/Notification");var ve=e.n(be);class ye extends(ve()){icon(){return"fas fa-file-export"}href(){const e=this.attrs.notification.subject();return s().forum.attribute("baseUrl")+`/gdpr/export/${e.file()}`}content(){const e=this.attrs.notification;return s().translator.trans("flarum-gdpr.forum.notification.export-ready",{username:C()(e.fromUser())})}excerpt(){return null}}flarum.reg.add("flarum-gdpr","forum/components/ExportAvailableNotification",ye);const xe=[...he,(new(le().Routes)).add("erasure-requests","/erasure-requests",de),(new(le().Notification)).add("gdprExportAvailable",ye)];s().initializers.add("flarum-gdpr",(()=>{s().erasureRequests=new n,k(),X(),ee(),ae(),(0,u.extend)(ne().prototype,"badges",(function(e){this.anonymized()&&e.add("anonymized",m(me(),{label:s().translator.trans("flarum-gdpr.forum.badges.anonymized_user"),icon:"fas fa-user-secret",type:"anonymized"}))}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map